# Complete End-to-End TCP Packet Flow

## Overview: Full Network Stack Journey
```
Application Data â†’ ByteStream â†’ TCP â†’ IPv4 â†’ Ethernet â†’ UDP (Real) â†’ Bounce Server â†’ UDP â†’ Ethernet â†’ IPv4 â†’ TCP â†’ ByteStream â†’ Application
     â”‚              â”‚           â”‚      â”‚        â”‚          â”‚             â”‚              â”‚        â”‚      â”‚      â”‚           â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              VIRTUAL (Simulated in  code)                                    VIRTUAL (Simulated in peer's code)
                                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              REAL (OS UDP socket)
```

## ðŸŽ­ Virtual vs Real: What's What?

### âš™ï¸ **VIRTUAL (Hardcoded/Simulated)** - Lives in C++ process
- **TCP layer** -  `tcp_sender.cc`, `tcp_receiver.cc`
- **IPv4 addresses** - `192.168.0.50`, `172.16.0.100` (private addresses, configured in code)
- **Ethernet** - MAC addresses generated randomly, frames exist only in memory
- **Router** -  `router.cc`, routing tables hardcoded in `endtoend.cc`
- **Network segments** - Simulated with Unix socket pairs

### ðŸŒ **REAL** - Handled by OS network stack
- **UDP socket** - System call to OS, real UDP/IP
- **IP addresses** -  machine's actual IP, bounce server's public IP (104.196.238.229)
- **Port numbers** - Real UDP ports (e.g., 3002 for bounce server)
- **Internet routing** - Real routers, ISP infrastructure

---

## Network Topology

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            CLIENT MACHINE                                    â”‚
â”‚                                                                              â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘                    VIRTUAL NETWORK (In-Memory)                        â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Application Layer: "Hello World"                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ByteStream (Reliable Byte Stream) ðŸŸ¦ VIRTUAL                         â”‚   â”‚
â”‚  â”‚ â€¢ Buffered data: "Hello World"                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ TCP Sender (tcp_sender.cc) ðŸŸ¦ VIRTUAL                                â”‚   â”‚
â”‚  â”‚ â€¢ SEQ: 1000 (simulated TCP state)                                    â”‚   â”‚
â”‚  â”‚ â€¢ Payload: "Hello World"                                             â”‚   â”‚
â”‚  â”‚ â€¢ Creates TCPSegment                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ TCP Layer (TCPMessage) ðŸŸ¦ VIRTUAL                                    â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚ â”‚ TCP Header:                                                    â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   SRC Port: 54321  ðŸŸ¦ HARDCODED in endtoend.cc                â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   DST Port: 1234   ðŸŸ¦ HARDCODED in endtoend.cc                â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   SEQ: 1000                                                   â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   ACK: 5000                                                   â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Flags: ACK, PSH                                             â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Window: 65535                                               â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Checksum: 0xABCD                                            â”‚   â”‚   â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚   â”‚
â”‚  â”‚ â”‚ Payload: "Hello World" (11 bytes)                             â”‚   â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Network Layer (IPv4 - InternetDatagram) ðŸŸ¦ VIRTUAL                  â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚ â”‚ IPv4 Header:                                                   â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Version: 4                                                  â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   IHL: 5 (20 bytes)                                           â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   TOS: 0                                                      â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Total Length: 51 (20 + 20 + 11)                            â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   ID: 12345                                                   â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   TTL: 64 ðŸŸ¦ HARDCODED initial value                          â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Protocol: 6 (TCP)                                           â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   SRC IP: 192.168.0.50  ðŸŸ¦ HARDCODED in endtoend.cc          â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   DST IP: 172.16.0.100  ðŸŸ¦ HARDCODED in endtoend.cc          â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Checksum: 0x1234                                            â”‚   â”‚   â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚   â”‚
â”‚  â”‚ â”‚ TCP Segment (31 bytes)                                         â”‚   â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚ send_datagram(dgram, next_hop=192.168.0.1)    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Network Interface (network_interface.cc) ðŸŸ¦ VIRTUAL                 â”‚   â”‚
â”‚  â”‚ â€¢ My MAC: 02:XX:XX:XX:XX:01  ðŸŸ¦ RANDOM generated at runtime         â”‚   â”‚
â”‚  â”‚ â€¢ My IP: 192.168.0.50        ðŸŸ¦ HARDCODED in endtoend.cc            â”‚   â”‚
â”‚  â”‚ â€¢ ARP Cache lookup for 192.168.0.1 (router) ðŸŸ¦ VIRTUAL ARP          â”‚   â”‚
â”‚  â”‚   - Found: MAC = 02:00:00:YY:YY:01                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Link Layer (Ethernet Frame) ðŸŸ¦ VIRTUAL                               â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚ â”‚ Ethernet Header:                                               â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   DST MAC: 02:00:00:YY:YY:01  ðŸŸ¦ From VIRTUAL ARP cache        â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   SRC MAC: 02:XX:XX:XX:XX:01  ðŸŸ¦ RANDOM generated              â”‚   â”‚   â”‚
â”‚  â”‚ â”‚   Type: 0x0800 (IPv4)                                         â”‚   â”‚   â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚   â”‚
â”‚  â”‚ â”‚ IPv4 Datagram (51 bytes)                                       â”‚   â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚ Total: 14 + 51 = 65 bytes                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚ transmit(frame) via OutputPort                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Virtual Network Segment (NetworkInterfaceAdapter) ðŸŸ¦ VIRTUAL         â”‚   â”‚
â”‚  â”‚ â€¢ Unix socket pair for frame transport (simulated wire)              â”‚   â”‚
â”‚  â”‚ â€¢ Writes Ethernet frame (65 bytes) to socket                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Router (Client Side) ðŸŸ¦ VIRTUAL                                      â”‚   â”‚
â”‚  â”‚ â€¢ Interface eth0: 192.168.0.1  ðŸŸ¦ HARDCODED in endtoend.cc          â”‚   â”‚
â”‚  â”‚ â€¢ Interface eth1: 10.0.0.192   ðŸŸ¦ HARDCODED in endtoend.cc          â”‚   â”‚
â”‚  â”‚ â€¢ Receives frame on eth0                                             â”‚   â”‚
â”‚  â”‚ â€¢ Routing table lookup: ðŸŸ¦ HARDCODED routes                          â”‚   â”‚
â”‚  â”‚   Destination: 172.16.0.100 â†’ Route via 10.0.0.172 on eth1          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Router's Internet Interface (10.0.0.192) ðŸŸ¦ VIRTUAL                  â”‚   â”‚
â”‚  â”‚ â€¢ Need MAC for next hop: 10.0.0.172                                  â”‚   â”‚
â”‚  â”‚ â€¢ ARP resolution (if needed) ðŸŸ¦ VIRTUAL                              â”‚   â”‚
â”‚  â”‚ â€¢ Create new Ethernet frame:                                         â”‚   â”‚
â”‚  â”‚   SRC MAC: Router's eth1 MAC ðŸŸ¦ RANDOM                               â”‚   â”‚
â”‚  â”‚   DST MAC: 10.0.0.172's MAC (from ARP) ðŸŸ¦ VIRTUAL                    â”‚   â”‚
â”‚  â”‚ â€¢ Decrement TTL: 64 â†’ 63 ðŸŸ¦  router.cc code                      â”‚   â”‚
â”‚  â”‚ â€¢ Recompute IPv4 checksum                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–¼â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘              TRANSITION TO REAL NETWORK                              â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ REAL UDP Socket (internet_socket) ðŸŸ¢ REAL OS SOCKET                  â”‚   â”‚
â”‚  â”‚ â€¢ Type: AF_INET, SOCK_DGRAM (OS system call)                         â”‚   â”‚
â”‚  â”‚ â€¢ Connected to: cs144.keithw.org:3002  ðŸŸ¢ REAL DNS + IP              â”‚   â”‚
â”‚  â”‚   Resolved IP: 104.196.238.229         ðŸŸ¢ REAL public IP             â”‚   â”‚
â”‚  â”‚ â€¢ Local port: 54782 (assigned by OS)   ðŸŸ¢ REAL ephemeral port        â”‚   â”‚
â”‚  â”‚ â€¢ Sends Ethernet frame (65 bytes) as UDP payload                     â”‚   â”‚
â”‚  â”‚   ðŸ“¦ Payload = VIRTUAL Ethernet frame (all virtual layers inside!)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ REAL INTERNET (UDP Transport) ðŸŸ¢
                             â”‚ Physical routers, switches, ISP infrastructure
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Real UDP Packet â”‚  ðŸŸ¢ REAL
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
                    â”‚  â”‚ Real IP Hdr: â”‚â”‚  ðŸŸ¢ OS adds this
                    â”‚  â”‚  SRC:    â”‚â”‚  ðŸŸ¢  real IP
                    â”‚  â”‚   public IP  â”‚â”‚
                    â”‚  â”‚  DST: 104.   â”‚â”‚  ðŸŸ¢ Bounce server's
                    â”‚  â”‚   196.238.229â”‚â”‚     real public IP
                    â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
                    â”‚  â”‚ Real UDP Hdr:â”‚â”‚  ðŸŸ¢ OS adds this
                    â”‚  â”‚  SRC Port:   â”‚â”‚  ðŸŸ¢ OS-assigned
                    â”‚  â”‚    54782     â”‚â”‚     ephemeral port
                    â”‚  â”‚  DST Port:   â”‚â”‚  ðŸŸ¢ Specified by
                    â”‚  â”‚    3002      â”‚â”‚      code
                    â”‚  â”‚  Length: 73  â”‚â”‚
                    â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
                    â”‚  â”‚ ðŸŸ¦ VIRTUAL   â”‚â”‚  ðŸŸ¦  code created
                    â”‚  â”‚ Ethernet     â”‚â”‚     this entire 65-byte
                    â”‚  â”‚ Frame        â”‚â”‚     blob, OS treats it
                    â”‚  â”‚ (65 bytes)   â”‚â”‚     as opaque payload
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ ðŸŸ¢ REAL Internet routing
                             â”‚    Real routers, ISPs, BGP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  BOUNCE SERVER (cs144.keithw.org:3002) ðŸŸ¢ REAL               â”‚
â”‚  IP: 104.196.238.229  ðŸŸ¢ Real public IP                                      â”‚
â”‚  Port: 3002           ðŸŸ¢ Real UDP port                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ UDP Socket (Port 3002) ðŸŸ¢ REAL OS SOCKET                              â”‚  â”‚
â”‚  â”‚ â€¢ Receives UDP datagram from OS                                        â”‚  â”‚
â”‚  â”‚ â€¢ Extracts Ethernet frame from UDP payload                             â”‚  â”‚
â”‚  â”‚ â€¢ Packet size: 65 bytes (treats as opaque blob)                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Bounce Logic (Relay State Machine) ðŸŸ¢ REAL relay software              â”‚  â”‚
â”‚  â”‚ â€¢ Client Registry:                                                      â”‚  â”‚
â”‚  â”‚   - Client A: 1.2.3.4:54782   ðŸŸ¢  real IP:port                     â”‚  â”‚
â”‚  â”‚   - Client B: 5.6.7.8:54783   ðŸŸ¢ Peer's real IP:port                   â”‚  â”‚
â”‚  â”‚                                                                         â”‚  â”‚
â”‚  â”‚ â€¢ Does NOT parse Ethernet frame content! ðŸŸ¦                            â”‚  â”‚
â”‚  â”‚ â€¢ Just maintains UDP address mappings                                   â”‚  â”‚
â”‚  â”‚                                                                         â”‚  â”‚
â”‚  â”‚ â€¢ Relay Decision:                                                       â”‚  â”‚
â”‚  â”‚   IF both clients connected â†’ Forward blob to peer                     â”‚  â”‚
â”‚  â”‚   ELSE â†’ Buffer blob, wait for peer to connect                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Relay to Peer (Client B) ðŸŸ¢ REAL UDP send                               â”‚  â”‚
â”‚  â”‚ â€¢ Wrap same 65-byte blob in new UDP packet                              â”‚  â”‚
â”‚  â”‚ â€¢ Send to: 5.6.7.8:54783  ðŸŸ¢ Real destination                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ ðŸŸ¢ REAL Internet routing (return path)
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Real UDP Packet â”‚  ðŸŸ¢ REAL
                    â”‚  (to Server)     â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
                    â”‚  â”‚ Real IP Hdr: â”‚â”‚  ðŸŸ¢ OS adds
                    â”‚  â”‚  SRC: Bounce â”‚â”‚  ðŸŸ¢ Bounce server IP
                    â”‚  â”‚   104.196... â”‚â”‚
                    â”‚  â”‚  DST: Server â”‚â”‚  ðŸŸ¢ Server's real IP
                    â”‚  â”‚   public IP  â”‚â”‚
                    â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
                    â”‚  â”‚ Real UDP Hdr:â”‚â”‚  ðŸŸ¢ OS adds
                    â”‚  â”‚  SRC Port:   â”‚â”‚
                    â”‚  â”‚    3002      â”‚â”‚
                    â”‚  â”‚  DST Port:   â”‚â”‚  ðŸŸ¢ Server's port
                    â”‚  â”‚    54783     â”‚â”‚     (OS-assigned)
                    â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
                    â”‚  â”‚ ðŸŸ¦ VIRTUAL   â”‚â”‚  ðŸŸ¦ Same 65-byte
                    â”‚  â”‚ Ethernet     â”‚â”‚     blob relayed
                    â”‚  â”‚ Frame        â”‚â”‚     unchanged!
                    â”‚  â”‚ (65 bytes)   â”‚â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ ðŸŸ¢ REAL Internet routing
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            SERVER MACHINE                                     â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â”‚
â”‚  â•‘              TRANSITION FROM REAL TO VIRTUAL                          â•‘   â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ REAL UDP Socket ðŸŸ¢ REAL OS SOCKET                                     â”‚  â”‚
â”‚  â”‚ â€¢ Local address: Server's real IP:54783  ðŸŸ¢ REAL                      â”‚  â”‚
â”‚  â”‚ â€¢ Receives UDP from bounce server (OS handles)                        â”‚  â”‚
â”‚  â”‚ â€¢ Extracts 65-byte payload â†’  code sees this as Ethernet frame    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–¼â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â”‚
â”‚  â•‘                    VIRTUAL NETWORK (In-Memory)                        â•‘   â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Router (Server Side) ðŸŸ¦ VIRTUAL                                        â”‚  â”‚
â”‚  â”‚ â€¢ Interface eth0: 10.0.0.172   ðŸŸ¦ HARDCODED in endtoend.cc            â”‚  â”‚
â”‚  â”‚ â€¢ Interface eth1: 172.16.0.1   ðŸŸ¦ HARDCODED in endtoend.cc            â”‚  â”‚
â”‚  â”‚ â€¢ Receives frame on eth0                                               â”‚  â”‚
â”‚  â”‚ â€¢ Routing table lookup: ðŸŸ¦ HARDCODED routes                            â”‚  â”‚
â”‚  â”‚   Destination: 172.16.0.100 â†’ Direct delivery on eth1                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Router's Host Interface (172.16.0.1) ðŸŸ¦ VIRTUAL                        â”‚  â”‚
â”‚  â”‚ â€¢ Need MAC for: 172.16.0.100                                            â”‚  â”‚
â”‚  â”‚ â€¢ ARP resolution for host ðŸŸ¦ VIRTUAL ARP                               â”‚  â”‚
â”‚  â”‚ â€¢ Create new Ethernet frame:                                            â”‚  â”‚
â”‚  â”‚   SRC MAC: Router's eth1 MAC ðŸŸ¦ RANDOM                                 â”‚  â”‚
â”‚  â”‚   DST MAC: Server host's MAC ðŸŸ¦ RANDOM                                 â”‚  â”‚
â”‚  â”‚ â€¢ Decrement TTL: 63 â†’ 62 ðŸŸ¦  router.cc code                        â”‚  â”‚
â”‚  â”‚ â€¢ Recompute IPv4 checksum                                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Network Interface (172.16.0.100) ðŸŸ¦ VIRTUAL                            â”‚  â”‚
â”‚  â”‚ â€¢ My MAC: 02:ZZ:ZZ:ZZ:ZZ:02  ðŸŸ¦ RANDOM generated                       â”‚  â”‚
â”‚  â”‚ â€¢ My IP: 172.16.0.100        ðŸŸ¦ HARDCODED in endtoend.cc               â”‚  â”‚
â”‚  â”‚ â€¢ Receive Ethernet frame                                                â”‚  â”‚
â”‚  â”‚ â€¢ Check: DST MAC == My MAC? YES                                         â”‚  â”‚
â”‚  â”‚ â€¢ Extract IPv4 datagram                                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚ recv_frame(frame)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Network Layer (IPv4 Processing) ðŸŸ¦ VIRTUAL                             â”‚  â”‚
â”‚  â”‚ â€¢ Verify checksum: OK                                                   â”‚  â”‚
â”‚  â”‚ â€¢ Check: DST IP == My IP? YES (172.16.0.100) ðŸŸ¦ HARDCODED             â”‚  â”‚
â”‚  â”‚ â€¢ Protocol: 6 (TCP)                                                     â”‚  â”‚
â”‚  â”‚ â€¢ Extract TCP segment                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ TCP Layer (TCP Receiver) ðŸŸ¦ VIRTUAL                                    â”‚  â”‚
â”‚  â”‚ â€¢ Parse TCP header:                                                     â”‚  â”‚
â”‚  â”‚   - SRC Port: 54321 ðŸŸ¦, DST Port: 1234 ðŸŸ¦ (HARDCODED in endtoend.cc)  â”‚  â”‚
â”‚  â”‚   - SEQ: 1000                                                           â”‚  â”‚
â”‚  â”‚   - ACK: 5000                                                           â”‚  â”‚
â”‚  â”‚   - Flags: ACK, PSH                                                     â”‚  â”‚
â”‚  â”‚ â€¢ Verify TCP checksum                                                   â”‚  â”‚
â”‚  â”‚ â€¢ Check sequence number (in window?)                                    â”‚  â”‚
â”‚  â”‚ â€¢ Pass to Reassembler                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Reassembler (reassembler.cc) ðŸŸ¦ VIRTUAL                                â”‚  â”‚
â”‚  â”‚ â€¢ Insert data at index: 1000                                            â”‚  â”‚
â”‚  â”‚ â€¢ Data: "Hello World" (11 bytes)                                        â”‚  â”‚
â”‚  â”‚ â€¢ Check for gaps                                                        â”‚  â”‚
â”‚  â”‚ â€¢ If contiguous â†’ Push to ByteStream                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ByteStream (Inbound) ðŸŸ¦ VIRTUAL                                        â”‚  â”‚
â”‚  â”‚ â€¢ Buffered data: "Hello World"                                          â”‚  â”‚
â”‚  â”‚ â€¢ Available for read: 11 bytes                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                            â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Application Layer                                                       â”‚  â”‚
â”‚  â”‚ â€¢ Read from socket: "Hello World"                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”‘ Legend

| Symbol | Meaning | Where Defined/Generated |
|--------|---------|-------------------------|
| ðŸŸ¦ | **VIRTUAL** - Simulated in  code |  C++ implementation |
| ðŸŸ¢ | **REAL** - Actual network operation | OS network stack |
| HARDCODED | Fixed value in source code | `apps/endtoend.cc`, line numbers below |
| RANDOM | Generated at runtime | `random_device()()` in test files |

---

## ðŸ“ Where Things Are Hardcoded (endtoend.cc)

```cpp
// Line ~210-230: Client configuration
if ( is_client ) {
  // HARDCODED: Client virtual network addresses
  host_side = router.add_interface(..., Address { "192.168.0.1" } );      // ðŸŸ¦
  internet_side = router.add_interface(..., Address { "10.0.0.192" } );   // ðŸŸ¦
  
  // HARDCODED: Client routing table
  router.add_route( Address { "192.168.0.0" }.ipv4_numeric(), 16, {}, host_side );
  router.add_route( Address { "10.0.0.0" }.ipv4_numeric(), 8, {}, internet_side );
  router.add_route( Address { "172.16.0.0" }.ipv4_numeric(), 12, 
                    Address { "10.0.0.172" }, internet_side );  // ðŸŸ¦ Route to server
} else {
  // HARDCODED: Server virtual network addresses
  host_side = router.add_interface(..., Address { "172.16.0.1" } );      // ðŸŸ¦
  internet_side = router.add_interface(..., Address { "10.0.0.172" } );  // ðŸŸ¦
  
  // HARDCODED: Server routing table
  router.add_route( Address { "172.16.0.0" }.ipv4_numeric(), 12, {}, host_side );
  router.add_route( Address { "10.0.0.0" }.ipv4_numeric(), 8, {}, internet_side );
  router.add_route( Address { "192.168.0.0" }.ipv4_numeric(), 16, 
                    Address { "10.0.0.192" }, internet_side );  // ðŸŸ¦ Route to client
}

// Line ~240: HARDCODED virtual host addresses
TCPSocketEndToEnd sock = is_client 
  ? TCPSocketEndToEnd { Address { "192.168.0.50" }, Address { "192.168.0.1" } }  // ðŸŸ¦
  : TCPSocketEndToEnd { Address { "172.16.0.100" }, Address { "172.16.0.1" } };  // ðŸŸ¦

// Line ~190-200: REAL network configuration
UDPSocket internet_socket;
Address bounce_address { bounce_host, bounce_port };  // ðŸŸ¢ From command line args

// Example: ./endtoend client cs144.keithw.org 3002
//          bounce_host = "cs144.keithw.org"  ðŸŸ¢ REAL DNS name
//          bounce_port = "3002"               ðŸŸ¢ REAL port number

internet_socket.connect( bounce_address );  // ðŸŸ¢ REAL OS socket connect

// Line ~320: HARDCODED virtual server endpoint
if ( is_client ) {
  sock.connect( Address { "172.16.0.100", 1234 } );  // ðŸŸ¦ Virtual destination
} else {
  sock.bind( Address { "172.16.0.100", 1234 } );     // ðŸŸ¦ Virtual bind
  sock.listen_and_accept();
}
```

---

## Detailed Step-by-Step Breakdown

### Phase 1: CLIENT - Application to Ethernet Frame (ðŸŸ¦ ALL VIRTUAL)

#### Step 1: Application writes data
```cpp
// Application code ( code or test)
string message = "Hello World";
sock.write(message);
// âœ“ This is just in-memory data in  process
```

#### Step 2: ByteStream buffers data (ðŸŸ¦ VIRTUAL)
```cpp
// byte_stream.cc -  implementation
ByteStream outbound;
outbound.write("Hello World");  // 11 bytes buffered in std::queue
// âœ“ Memory buffer, no OS involvement yet
```

#### Step 3: TCP Sender creates segment (ðŸŸ¦ VIRTUAL)
```cpp
// tcp_sender.cc -  implementation
TCPSenderMessage msg;
msg.seqno = Wrap32::wrap(1000, isn);  // Sequence number from  TCP state
msg.payload = "Hello World";
msg.SYN = false;
msg.FIN = false;
msg.RST = false;
// âœ“ All state maintained in  C++ objects
// âœ“ No kernel TCP stack involved!
```

#### Step 4: TCP wraps in TCPMessage (ðŸŸ¦ VIRTUAL)
```cpp
// TCPMessage structure -  virtual TCP
TCPMessage tcp_msg {
  .sender_message = msg,
  .receiver_message = {
    .ackno = Wrap32::wrap(5000, peer_isn),
    .window_size = 65535
  }
};

// Serialize to TCP header + payload
// SRC:54321 ðŸŸ¦ HARDCODED (line ~315 in endtoend.cc)
// DST:1234  ðŸŸ¦ HARDCODED (line ~320 in endtoend.cc)
// + "Hello World"
```

#### Step 5: IPv4 wraps TCP segment (ðŸŸ¦ VIRTUAL)
```cpp
// network_interface.cc â†’ send_datagram()
InternetDatagram dgram;
dgram.header.src = 0xC0A80032;  // 192.168.0.50  ðŸŸ¦ HARDCODED (line ~240)
dgram.header.dst = 0xAC100064;  // 172.16.0.100  ðŸŸ¦ HARDCODED (line ~320)
dgram.header.proto = 6;          // TCP
dgram.header.ttl = 64;           // ðŸŸ¦ Initial value
dgram.payload = serialize(tcp_msg);
dgram.header.len = 20 + tcp_msg.size();
dgram.header.compute_checksum();

// âœ“ This IPv4 packet exists only in memory
// âœ“ OS will never see this IP header!
```

#### Step 6: Network Interface creates Ethernet frame (ðŸŸ¦ VIRTUAL)
```cpp
// network_interface.cc -  implementation
void NetworkInterface::send_datagram(const InternetDatagram& dgram, 
                                     const Address& next_hop) {
  // next_hop = 192.168.0.1 (router) ðŸŸ¦ VIRTUAL address
  uint32_t next_hop_ip = next_hop.ipv4_numeric();
  
  // ARP lookup (ðŸŸ¦ VIRTUAL ARP cache)
  if (ARP_cache_.contains(next_hop_ip)) {
    EthernetAddress dst_mac = ARP_cache_[next_hop_ip].first;  // ðŸŸ¦ VIRTUAL MAC
    
    EthernetFrame frame;
    frame.header.dst = dst_mac;              // Router's MAC (ðŸŸ¦ RANDOM)
    frame.header.src = ethernet_address_;    // My MAC (ðŸŸ¦ RANDOM)
    frame.header.type = EthernetHeader::TYPE_IPv4;  // 0x0800
    frame.payload = serialize(dgram);
    
    transmit(frame);  // Send to OutputPort (Unix socket, not real wire!)
  } else {
    // Queue datagram, send ARP request (ðŸŸ¦ ALL VIRTUAL)
    dgrams_waitting_[next_hop_ip].push_back(dgram);
    ARPMessage arp_req = make_arp(ARPMessage::OPCODE_REQUEST, {}, next_hop_ip);
    transmit({
      {ETHERNET_BROADCAST, ethernet_address_, EthernetHeader::TYPE_ARP},
      serialize(arp_req)
    });
  }
}

// âœ“ Ethernet frame exists only in memory
// âœ“ No real NIC (network card) involved!
```

### Phase 2: CLIENT Router Processing (ðŸŸ¦ ALL VIRTUAL)

#### Step 7: Router receives frame (ðŸŸ¦ VIRTUAL routing)
```cpp
// endtoend.cc â†’ Router processing
// Unix socket read simulates "receiving" frame from virtual wire
event_loop.add_rule("frames from host to router", 
  sock.adapter().frame_fd(), Direction::In, [&] {
  
  EthernetFrame frame = receive_frame();  // Read from Unix socket
  // Frame received on VIRTUAL interface eth0 (192.168.0.1) ðŸŸ¦
  
  router.interface(host_side)->recv_frame(frame);
  router.route();
});

// âœ“ This is inter-process communication (Unix socket)
// âœ“ Not real Ethernet!
```

#### Step 8: Router routes packet (ðŸŸ¦ VIRTUAL routing table)
```cpp
// router.cc -  implementation
void Router::route() {
  for (auto& interface : interfaces_) {
    while (!interface->datagrams_received().empty()) {
      InternetDatagram dgram = interface->datagrams_received().front();
      
      // Routing table lookup (ðŸŸ¦ HARDCODED in endtoend.cc line ~210-230)
      // DST: 172.16.0.100 â†’ Match route: via 10.0.0.172 on eth1
      
      optional<RouteEntry> match = longest_prefix_match(dgram.header.dst);
      
      if (match) {
        // Decrement TTL (ðŸŸ¦  CODE modifies virtual IP header)
        dgram.header.ttl--;  // 64 â†’ 63
        if (dgram.header.ttl == 0) {
          // Drop packet (ðŸŸ¦ virtual drop, just don't forward)
          continue;
        }
        dgram.header.compute_checksum();  // Recompute for modified header
        
        // Send out internet-facing interface (ðŸŸ¦ VIRTUAL forwarding)
        Address next_hop = match->next_hop.has_value() 
                          ? match->next_hop.value() 
                          : Address::from_ipv4_numeric(dgram.header.dst);
        
        interfaces_[match->interface_id]->send_datagram(dgram, next_hop);
      }
      
      interface->datagrams_received().pop();
    }
  }
}

// âœ“ All routing happens in  code
// âœ“ OS routing table not involved!
```

### Phase 3: Real UDP Transport to Bounce Server (ðŸŸ¢ REAL NETWORK!)

#### Step 9: Send via real UDP socket (ðŸŸ¢ FIRST REAL NETWORK OPERATION!)
```cpp
// endtoend.cc
event_loop.add_rule("frames from router to Internet",
  internet_socket, Direction::Out, [&] {
  
  EthernetFrame& frame = router_to_internet->frames.front();
  
  // This is a REAL UDP socket! ðŸŸ¢
  // Connected to: cs144.keithw.org:3002 (ðŸŸ¢ REAL DNS, REAL IP)
  internet_socket.write(serialize(frame));  // ðŸŸ¢ OS system call!
  // Writes 65-byte Ethernet frame as UDP payload
  
  router_to_internet->frames.pop();
});

// What the OS does (ðŸŸ¢ REAL):
// 1. Takes 65-byte buffer ( Ethernet frame)
// 2. Adds REAL UDP header (8 bytes)
//    - SRC Port: OS-assigned ephemeral port (e.g., 54782)
//    - DST Port: 3002 (from  connect() call)
// 3. Adds REAL IPv4 header (20 bytes)
//    - SRC IP:  machine's real IP
//    - DST IP: 104.196.238.229 (bounce server, from DNS resolution)
// 4. Adds REAL Ethernet header (if on Ethernet)
//    - SRC MAC:  NIC's real MAC
//    - DST MAC: Next hop router's MAC (from OS ARP)
// 5. Sends on REAL network interface (eth0/wlan0/etc.)
```

**Real UDP Packet Structure (ðŸŸ¢ OS creates this):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Real Ethernet Header    â”‚ ðŸŸ¢ Added by OS
â”‚  SRC:  NIC MAC      â”‚
â”‚  DST: Gateway MAC       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Real IP Header          â”‚ ðŸŸ¢ Added by OS
â”‚  SRC:  public IP    â”‚ ðŸŸ¢ From  network config
â”‚  DST: 104.196.238.229   â”‚ ðŸŸ¢ Bounce server (DNS resolved)
â”‚  Protocol: 17 (UDP)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Real UDP Header         â”‚ ðŸŸ¢ Added by OS
â”‚  SRC Port: 54782        â”‚ ðŸŸ¢ OS-assigned
â”‚  DST Port: 3002         â”‚ ðŸŸ¢ From  code
â”‚  Length: 73 (8+65)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Payload (65 bytes):     â”‚ ðŸŸ¦ From  code
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Ethernet Header  â”‚   â”‚ ðŸŸ¦ VIRTUAL ( code made this)
â”‚  â”‚  DST: Router MAC â”‚   â”‚ ðŸŸ¦ Random virtual MAC
â”‚  â”‚  SRC: Host MAC   â”‚   â”‚ ðŸŸ¦ Random virtual MAC
â”‚  â”‚  Type: IPv4      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ IPv4 Header      â”‚   â”‚ ðŸŸ¦ VIRTUAL ( code made this)
â”‚  â”‚  SRC: 192.168..  â”‚   â”‚ ðŸŸ¦ Hardcoded virtual IP
â”‚  â”‚  DST: 172.16..   â”‚   â”‚ ðŸŸ¦ Hardcoded virtual IP
â”‚  â”‚  Proto: TCP      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ TCP Header+Data  â”‚   â”‚ ðŸŸ¦ VIRTUAL ( code made this)
â”‚  â”‚  "Hello World"   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

IMPORTANT: 
- Outer layers (Real Ethernet/IP/UDP): OS handles, uses REAL addresses ðŸŸ¢
- Inner layers (Virtual Ethernet/IP/TCP):  code created, uses VIRTUAL addresses ðŸŸ¦
- OS treats inner 65 bytes as opaque binary data!
```

### Phase 4: Bounce Server Processing (ðŸŸ¢ REAL UDP, ðŸŸ¦ VIRTUAL relay)

#### Step 10: Bounce server receives and relays
```python
# Conceptual bounce server logic (Stanford's server, not  Python script)
# This is a REAL server running on REAL hardware! ðŸŸ¢

class BounceServer:
    def __init__(self):
        # REAL socket ðŸŸ¢
        self.sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        self.sock.bind(('0.0.0.0', 3002))  # ðŸŸ¢ REAL port binding
        
        self.clients = {}  # Maps: (real_ip, real_port) â†’ (peer_real_ip, peer_real_port)
        
    def handle_packet(self, data, addr):
        # data = 65-byte blob ( Ethernet frame) ðŸŸ¦
        # addr = (client_real_ip, client_real_port) ðŸŸ¢ From OS
        
        # Bounce server does NOT parse Ethernet/IP/TCP! ðŸŸ¦
        # It just treats data as opaque 65-byte blob
        
        # Client registration (happens when first packet arrives)
        if addr not in self.clients:
            # Wait for peer to connect
            self.pending[addr] = data
            return
        
        # Find peer (based on UDP address pairing) ðŸŸ¢
        peer_addr = self.clients[addr]  # (peer_real_ip, peer_real_port)
        
        # Relay: Send the SAME 65-byte blob to peer via REAL UDP ðŸŸ¢
        self.sock.sendto(data, peer_addr)  # OS system call
        
    def register_clients(self, client_a_addr, client_b_addr):
        # Pair clients so they can communicate
        # These are REAL IP:port pairs! ðŸŸ¢
        self.clients[client_a_addr] = client_b_addr
        self.clients[client_b_addr] = client_a_addr
```

**Key Insight:** The bounce server:
1. âœ… Uses REAL UDP sockets (OS-managed) ðŸŸ¢
2. âœ… Knows REAL client IP addresses and ports ðŸŸ¢
3. âŒ Does NOT understand the 65-byte payload (Ethernet frame) ðŸŸ¦
4. âœ… Simply relays bytes between paired clients
5. âŒ Cannot read  "Hello World" (inside virtual TCP, inside virtual IP, inside virtual Ethernet!)

### Phase 5: SERVER - Receive and Process

#### Step 11: Server receives UDP from bounce (ðŸŸ¢ REAL â†’ ðŸŸ¦ VIRTUAL transition)
```cpp
// Server's endtoend.cc
event_loop.add_rule("frames from Internet to router",
  internet_socket, Direction::In, [&] {
  
  // Real UDP receive (ðŸŸ¢ OS gives us data)
  // OS has stripped off: Real Ethernet, Real IP, Real UDP headers
  // We get: 65-byte payload (our virtual Ethernet frame) ðŸŸ¦
  
  EthernetFrame frame = receive_frame(internet_socket);
  
  // Give to router's internet-facing interface (ðŸŸ¦ back to virtual world)
  router.interface(internet_side)->recv_frame(frame);
  router.route();  // Virtual routing
});

// âœ“ Transition point: Real network â†’ Virtual network
```

#### Step 12: Server router processes (ðŸŸ¦ VIRTUAL routing)
```cpp
// router.cc on server
// Frame arrives on VIRTUAL eth0 (10.0.0.172) ðŸŸ¦
// DST IP: 172.16.0.100 ðŸŸ¦ (from virtual IP header)
// Routing table: 172.16.0.0/12 â†’ direct on eth1 (172.16.0.1) ðŸŸ¦ HARDCODED

void Router::route() {
  // ... same routing logic as client router ...
  // Decrement TTL: 63 â†’ 62 ðŸŸ¦
  // Forward to host-side interface (ðŸŸ¦ VIRTUAL)
  interfaces_[host_side]->send_datagram(dgram, Address{"172.16.0.100"});
}
```

#### Step 13: Server network interface receives (ðŸŸ¦ VIRTUAL)
```cpp
// network_interface.cc on server (172.16.0.100)
void NetworkInterface::recv_frame(const EthernetFrame& frame) {
  // Check destination
  if (frame.header.dst != ethernet_address_ && 
      frame.header.dst != ETHERNET_BROADCAST) {
    return;  // Not for me
  }
  
  // IPv4 datagram
  if (frame.header.type == EthernetHeader::TYPE_IPv4) {
    InternetDatagram dgram;
    if (parse(dgram, frame.payload)) {
      // Verify: dgram.header.dst == my IP (172.16.0.100)
      // Protocol: 6 (TCP)
      datagrams_received_.push(dgram);
    }
  }
}
```

#### Step 14: TCP receiver processes
```cpp
// tcp_receiver.cc
void TCPReceiver::receive(const TCPSenderMessage& msg) {
  // msg.seqno = 1000
  // msg.payload = "Hello World"
  
  if (msg.RST) {
    // Handle reset
    return;
  }
  
  // Convert seqno to stream index
  uint64_t checkpoint = bytes_pushed;
  uint64_t abs_seqno = msg.seqno.unwrap(isn, checkpoint);
  uint64_t stream_index = abs_seqno - 1;  // -1 for SYN
  
  // Pass to reassembler
  reassembler_.insert(stream_index, msg.payload, msg.FIN);
}
```

#### Step 15: Reassembler processes
```cpp
// reassembler.cc
void Reassembler::insert(uint64_t first_index, 
                        string data, 
                        bool is_last_substring) {
  // first_index = 999 (stream index)
  // data = "Hello World"
  
  // Check if in window
  uint64_t next_expected = output_.writer().bytes_pushed();
  uint64_t available_capacity = output_.writer().available_capacity();
  
  if (first_index >= next_expected && 
      first_index < next_expected + available_capacity) {
    
    // Store in buffer if not contiguous
    // Or push directly if next expected
    if (first_index == next_expected) {
      output_.writer().push(data);
      bytes_pending_ -= data.size();
    } else {
      // Buffer for later
      pending_data_[first_index] = data;
      bytes_pending_ += data.size();
    }
  }
  
  if (is_last_substring) {
    output_.writer().close();
  }
}
```

#### Step 16: Application reads data
```cpp
// Application on server
string received = sock.read(11);
// received = "Hello World"

cout << "Received: " << received << endl;
```

---

## Return Path (ACK)

The ACK follows the **exact reverse path**:

```
Server ByteStream â†’ TCP Sender (ACK) â†’ IPv4 â†’ Ethernet â†’ 
Router â†’ UDP â†’ Bounce Server â†’ UDP â†’ 
Router â†’ Ethernet â†’ IPv4 â†’ TCP Receiver (ACK) â†’ Client
```

**TCP ACK Message:**
```cpp
TCPMessage ack_msg {
  .sender_message = {
    .seqno = Wrap32::wrap(5000, server_isn),
    .payload = "",  // No data, just ACK
    .FIN = false,
  },
  .receiver_message = {
    .ackno = Wrap32::wrap(1011, client_isn),  // 1000 + 11 bytes
    .window_size = 65535
  }
};
```

---

## Key Address Translations

### Client Side:
| Layer | Source | Destination |
|-------|--------|-------------|
| Application | - | - |
| TCP | Port 54321 | Port 1234 |
| IPv4 (virtual) | 192.168.0.50 | 172.16.0.100 |
| Ethernet (virtual) | 02:XX:XX:XX:XX:01 | 02:00:00:YY:YY:01 (router) |
| **Router transforms** | | |
| Ethernet (virtual) | 02:00:00:YY:YY:02 (router) | 02:AA:AA:AA:AA:01 |
| IPv4 (virtual) | 192.168.0.50 | 172.16.0.100 |
| **Real UDP wrapping** | | |
| UDP (real) | Port 54782 | Port 3002 |
| IPv4 (real) |  public IP | 104.196.238.229 |

### Bounce Server:
- **Receives:** Real UDP from Client A
- **Extracts:** Virtual Ethernet frame
- **Forwards:** Same Ethernet frame in Real UDP to Client B
- **No modification** to inner layers!

### Server Side:
| Layer | Source | Destination |
|-------|--------|-------------|
| IPv4 (real) | 104.196.238.229 | Server public IP |
| UDP (real) | Port 3002 | Port 54783 |
| **Real UDP unwrapping** | | |
| Ethernet (virtual) | 02:AA:AA:AA:AA:01 | 02:BB:BB:BB:BB:02 (router) |
| **Router transforms** | | |
| Ethernet (virtual) | 02:BB:BB:BB:BB:01 (router) | 02:ZZ:ZZ:ZZ:ZZ:02 |
| IPv4 (virtual) | 192.168.0.50 | 172.16.0.100 |
| TCP | Port 54321 | Port 1234 |
| Application | - | - |

---

## Summary

1. **Virtual TCP/IP stack** runs completely inside  process
2. **Virtual Ethernet frames** are serialized and sent via **real UDP**
3. **Bounce server** simply relays Ethernet frames between paired clients
4. **No middle box** (except bounce server) sees the TCP/IP details
5. **End-to-end encryption** possible at TCP layer (bounce server can't read)

This is essentially **VPN/tunnel** technology - encapsulating one protocol inside another! ðŸš€
